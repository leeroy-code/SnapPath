name: Build and Release

on:
  push:
    branches: ["main", "master"]
    tags:
      - "v*"
  pull_request:
    branches: ["main", "master"]

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Build Universal Binary
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            version="${GITHUB_REF_NAME#v}"
            if ! echo "${version}" | grep -Eq '^[0-9]+(\.[0-9]+){0,2}$'; then
              echo "Invalid tag version: ${GITHUB_REF_NAME} (expected v1.2.3)" >&2
              exit 1
            fi

            xcodebuild archive \
              -project SnapPath.xcodeproj \
              -scheme SnapPath \
              -configuration Release \
              -archivePath build/SnapPath.xcarchive \
              -destination "generic/platform=macOS" \
              ARCHS="x86_64 arm64" \
              ONLY_ACTIVE_ARCH=NO \
              SKIP_INSTALL=NO \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=YES \
              OTHER_CODE_SIGN_FLAGS="--deep --force" \
              MARKETING_VERSION="${version}" \
              CURRENT_PROJECT_VERSION="${version}"
          else
            xcodebuild archive \
              -project SnapPath.xcodeproj \
              -scheme SnapPath \
              -configuration Release \
              -archivePath build/SnapPath.xcarchive \
              -destination "generic/platform=macOS" \
              ARCHS="x86_64 arm64" \
              ONLY_ACTIVE_ARCH=NO \
              SKIP_INSTALL=NO \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=YES \
              OTHER_CODE_SIGN_FLAGS="--deep --force"
          fi

      - name: Export App
        run: |
          mkdir -p build/Export
          cp -R build/SnapPath.xcarchive/Products/Applications/SnapPath.app build/Export/SnapPath.app

      - name: Verify Architecture
        run: |
          lipo -info build/Export/SnapPath.app/Contents/MacOS/SnapPath

      - name: Create ZIP
        run: |
          mkdir -p build/ReleaseAssets
          cd build/Export
          zip -r ../ReleaseAssets/SnapPath.zip SnapPath.app

      - name: Build Sparkle Tools
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          set -euo pipefail

          git clone --depth 1 --branch 2.8.1 https://github.com/sparkle-project/Sparkle.git build/Sparkle
          xcodebuild build \
            -project build/Sparkle/Sparkle.xcodeproj \
            -scheme generate_appcast \
            -configuration Release \
            -derivedDataPath build/SparkleDerivedData

      - name: Generate Sparkle appcast.xml
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_ED25519_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          if [[ -z "${SPARKLE_ED25519_PRIVATE_KEY}" ]]; then
            echo "Missing secret: SPARKLE_ED25519_PRIVATE_KEY" >&2
            exit 1
          fi

          if /usr/libexec/PlistBuddy -c 'Print :SUPublicEDKey' Info.plist | grep -qx 'placeholder_public_key'; then
            echo "Info.plist SUPublicEDKey is still placeholder_public_key. Generate a Sparkle key and replace it before releasing." >&2
            exit 1
          fi

          download_prefix="https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/"
          generate_appcast="build/SparkleDerivedData/Build/Products/Release/generate_appcast"

          echo "${SPARKLE_ED25519_PRIVATE_KEY}" | "${generate_appcast}" \
            --ed-key-file - \
            --download-url-prefix "${download_prefix}" \
            --maximum-deltas 0 \
            -o build/ReleaseAssets/appcast.xml \
            build/ReleaseAssets

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/ReleaseAssets/SnapPath.zip
            build/ReleaseAssets/appcast.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SnapPath-app
          path: build/ReleaseAssets/SnapPath.zip
